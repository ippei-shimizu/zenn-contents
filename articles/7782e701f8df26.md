---
title: "ãƒãƒ³ã‚ºã‚ªãƒ³ï¼Next.js+Hono+RPC+Supabase+Drizzle+pnpm+Turborepoã§ä½œã‚‹ãƒ¢ãƒãƒ¬ãƒæ§‹æˆã®ã‚¢ãƒ—ãƒªé–‹ç™º"
emoji: "ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Nextjs", "TypeScript", "Hono","Supabase","Cloudflare"]
published: false
---

## ã¯ã˜ã‚ã«

ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚¹ã‚¯ãƒ¼ãƒ«RUNTEQã§Webã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢å…¼è¬›å¸«ã‚’ã—ã¦ã„ã‚‹ã„ã£ãºã„ï¼ˆ[@ippei_111](https://x.com/ippei_111)ï¼‰ã¨ç”³ã—ã¾ã™ã€‚

ä»Šå›ã¯ã€TypeScriptã‚’ä½¿ç”¨ã—ã¦ã€Next.js+Hono+RPC+Supabase+Drizzle+pnpm+Turborepoã®ãƒ¢ãƒãƒ¬ãƒæ§‹æˆã®ã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã‚’ãƒãƒ³ã‚ºã‚ªãƒ³å½¢å¼ã§ç´¹ä»‹ã—ã¦ã„ãã¾ã™ã€‚

æœ¬è¨˜äº‹ã§ä½œæˆã™ã‚‹ã‚¢ãƒ—ãƒªã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¯Next.jsã®App Routerã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¯Honoãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’ä½¿ç”¨ã—ã€Cloudflare Workersã«ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯Supabaseã®PostgreSQLã‚’åˆ©ç”¨ã—ã€ORM/ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ã¨ã—ã¦Drizzleã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ã€‚ãƒ¢ãƒãƒ¬ãƒæ§‹æˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç†ã«ã¯pnpm Workspaceã¨Turborepoã‚’ä½¿ç”¨ã—ã¾ã™ã€‚

## Honoã¨ã¯

https://hono.dev/


## Hono RPCã¨ã¯

https://hono.dev/docs/guides/rpc

## pnpm Workspaceã¨ã¯

https://pnpm.io/ja/workspaces

## Turborepoã¨ã¯

https://turbo.build/

## ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ¦‚è¦
### å®Œæˆç³»ã®ã‚¤ãƒ¡ãƒ¼ã‚¸

### æ¦‚è¦
ä»Šå›ã¯ã€ãƒãƒ³ã‚ºã‚ªãƒ³å½¢å¼ã§ã€Next.js+Hono+RPC+Supabase+Drizzle+pnpm+Turborepoã®ãƒ¢ãƒãƒ¬ãƒæ§‹æˆã®ã‚¢ãƒ—ãƒªã‚’ä½œæˆã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã™ã‚‹ãŸã‚ã€åŸºæœ¬çš„ãªè¨˜äº‹ã®CRUDæ©Ÿèƒ½ã‚’æŒã¤ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹ç™ºã—ã¾ã™ã€‚

â€» æœ¬è¨˜äº‹ã¯ç­†è€…ãŒmacOSã§é–‹ç™ºã‚’è¡Œã£ã¦ã„ã‚‹ãŸã‚ã€macOSã‚’å‰æã«ã—ãŸå†…å®¹ã«ãªã£ã¦ã„ã¾ã™ã€‚

### ã‚„ã‚‰ãªã„ã“ã¨
- èªè¨¼æ©Ÿèƒ½
- ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- ãƒ¢ãƒãƒ¬ãƒæ§‹æˆ
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ : Next.js App Routerã‚’ä½¿ç”¨ã—ã¦ã€Vercelã«ãƒ‡ãƒ—ãƒ­ã‚¤
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ : Honoã‚’ä½¿ç”¨ã—ã¦ã€Cloudflare Workersã«ãƒ‡ãƒ—ãƒ­ã‚¤
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ : Supabase
- ORM/ã‚¯ã‚¨ãƒªãƒ“ãƒ«ãƒ€ãƒ¼ : Drizzle
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç† : pnpm Workspaceã¨Turborepo

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆ

ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹æˆã¯ä»¥ä¸‹ã‚’æƒ³å®šã—ã¦ã„ã¾ã™ã€‚

```bash
/
â”œâ”€â”€ .turbo/
â”œâ”€â”€ node_modules/
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ api/                     # Honoãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ routes/          # Honoãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
â”‚   â”‚   â”‚   â”œâ”€â”€ schemas/         # Zodã‚¹ã‚­ãƒ¼ãƒ
â”‚   â”‚   â”‚   â””â”€â”€ types/           # å…±é€šã®å‹å®šç¾©
â”‚   â”‚   â”œâ”€â”€ supabase/
â”‚   â”‚   â”œâ”€â”€ .dev.vars
â”‚   â”‚   â”œâ”€â”€ .prod.vars
â”‚   â”‚   â”œâ”€â”€ drizzle.config.ts
â”‚   â”‚   â””â”€â”€ wrangler.jsonc
â”‚   â”‚
â”‚   â””â”€â”€ frontend/                # Next.jsãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ app/             # Next.js App Router
â”‚       â”‚   â”œâ”€â”€ services/        # ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ä½¿ç”¨ã™ã‚‹APIé€šä¿¡
â”‚       â”‚   â””â”€â”€ lib/             # ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚       â”œâ”€â”€ public/
â”‚       â””â”€â”€ middleware.ts
â”œâ”€â”€ package.json
â”œâ”€â”€ pnpm-lock.yaml
â”œâ”€â”€ pnpm-workspace.yaml
â”œâ”€â”€ tsconfig.json
â””â”€â”€ turbo.json
```
- `node_modules/` : ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®å…±æœ‰ä¾å­˜é–¢ä¿‚
- `package.json` : ãƒ«ãƒ¼ãƒˆãƒ¬ãƒ™ãƒ«ã®ä¾å­˜é–¢ä¿‚ã¨å…±é€šã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®šç¾©
- `pnpm-workspace.yaml` : pnpmã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹è¨­å®š
- `turbo.json` : Turborepoã®è¨­å®š
- `packages/api` : Honoãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ ¼ç´ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
  - `src/routes` : Honoã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’æ ¼ç´ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
  - `src/schemas` : Zodã‚¹ã‚­ãƒ¼ãƒã‚’æ ¼ç´ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
  - `src/types` : å…±é€šã®å‹å®šç¾©ã‚’æ ¼ç´ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
  - `supabase` : Supabaseãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ ¼ç´ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
  - `wrangler.jsonc` : Cloudflare Workersã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«
- `packages/frontend` : Next.jsãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’æ ¼ç´ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
  - `src/services` : ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ä½¿ç”¨ã™ã‚‹APIé€šä¿¡ã‚’æ ¼ç´ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
  - `src/lib` : APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’æ ¼ç´ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª

### æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
ä»Šå›ã€ä½¿ç”¨ã™ã‚‹æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯ã¯ä»¥ä¸‹ã®é€šã‚Šã«ãªã‚Šã¾ã™ã€‚

| ã‚«ãƒ†ã‚´ãƒª | æŠ€è¡“ |
| ---- | ---- |
| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ | Next.js 15.2.4 / React 19.0.0 / TypeScript 5.0 |
| ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ | Hono 4.7.5 |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | Supabase / Drizzle ORM 0.41.0 |
| ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç®¡ç† | pnpm 10.6.3 / Turborepo 2.4.4 |
| ãƒ‡ãƒ—ãƒ­ã‚¤ | Vercel / Cloudflare Workers |

## ãƒ¢ãƒãƒ¬ãƒæ§‹æˆã‚’æ¡ç”¨ã—ãŸç†ç”±
ãƒ¢ãƒãƒ¬ãƒï¼ˆMonorepoï¼‰ã¯ã€è¤‡æ•°ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’1ã¤ã®ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã™ã‚‹æ‰‹æ³•ã§ã™ã€‚ä»Šå›ã¯ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆNext.jsï¼‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆHonoï¼‰ã‚’åŒã˜ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã™ã‚‹ã“ã¨ã§ã€å‹ã‚„ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®å…±æœ‰ã‚’å®¹æ˜“ã«ã—ã€é–‹ç™ºåŠ¹ç‡ã‚’å‘ä¸Šã•ã›ã¦ã„ããŸã„ã¨è€ƒãˆã€ãƒ¢ãƒãƒ¬ãƒæ§‹æˆã‚’æ¡ç”¨ã—ã¾ã—ãŸã€‚

### ğŸ™†â€â™‚ï¸ ãƒ¢ãƒãƒ¬ãƒæ§‹æˆã‚’æ¡ç”¨ã™ã‚‹ãƒ¡ãƒªãƒƒãƒˆ

ãƒ¢ãƒãƒ¬ãƒã®ãƒ¡ãƒªãƒƒãƒˆã«ã¤ã„ã¦ã€æŠ€è¡“çš„ãªè¦³ç‚¹ã§æ„Ÿã˜ãŸã“ã¨ã‚’ä»¥ä¸‹ã«ã¾ã¨ã‚ã¦ã¿ã¾ã—ãŸã€‚

**â—¼ï¸ å‹å…±æœ‰**
ä»Šå›ã€TypeScriptã‚’ä½¿ç”¨ã—ã¦ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’é–‹ç™ºã™ã‚‹ãŸã‚ã€APIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å‹ã‚„å…¥åŠ›å€¤ã®å‹ã‚’ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§å…±æœ‰ã™ã‚‹ã“ã¨ã§ã€å‹ä¸ä¸€è‡´ã«ã‚ˆã‚‹ãƒã‚°ã‚’é˜²ãã“ã¨ãŒã§ãã¾ã™ã€‚

**â—¼ï¸ Lintã‚„Formatã®ä¸€å…ƒç®¡ç†**
ESLintã‚„Prettierãªã©ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ«ãƒ¼ãƒˆã«é…ç½®ã™ã‚‹ã“ã¨ã§ã€å…¨ã¦ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ»ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã§åŒã˜ãƒ«ãƒ¼ãƒ«ã‚’é©ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

**â—¼ï¸ issueã‚„Pull Requestã®ä¸€å…ƒç®¡ç†**
ä»Šå›ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚ˆã†ã«ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«ã¾ãŸãŒã‚‹é–‹ç™ºã‚’è¡Œã†å ´åˆã€1ã¤ã®ãƒªãƒã‚¸ãƒˆãƒªã§issueã‚„Pull Requestã‚’ç®¡ç†ã™ã‚‹ã“ã¨ã¯é–‹ç™ºã®ç®¡ç†ã‚’å®¹æ˜“ã«ã—ã¾ã™ã€‚

### ğŸ™…â€â™‚ï¸ ãƒ¢ãƒãƒ¬ãƒæ§‹æˆã‚’æ¡ç”¨ã™ã‚‹ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ
ãƒ¢ãƒãƒ¬ãƒã®ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¨ã—ã¦ã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå¤§ãããªã‚‹ã«ã¤ã‚Œã¦ãƒªãƒã‚¸ãƒˆãƒªã‚µã‚¤ã‚ºãŒå¤§ãããªã‚Šã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–“ã®ä¾å­˜é–¢ä¿‚ãŒè¤‡é›‘ã«ãªã£ã¦ã—ã¾ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

## ã‚µãƒ¼ãƒãƒ¬ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã—ãŸç†ç”±
ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯ã€ã‚µãƒ¼ãƒãƒ¼ç®¡ç†ã‚„é‹ç”¨ã‚’ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãŒè¡Œã†ãŸã‚ã€é–‹ç™ºè€…ã¯ã‚µãƒ¼ãƒãƒ¼ã«ã¤ã„ã¦è€ƒãˆã‚‹å¿…è¦ãŒãªããªã‚Šã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ¼ãƒ‰ã«é›†ä¸­ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§ã™ã€‚
ä»Šå›ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®Honoã®å®Ÿè¡Œç’°å¢ƒã¨ã—ã¦ã€Cloudflare Workersã‚’é¸æŠã—ãŸç†ç”±ã¨ã—ã¦ã¯ã€å€‹äººé–‹ç™ºã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ãªã‚‹ãŸã‚ã€ã§ãã‚‹ã ã‘é‹ç”¨ã‚³ã‚¹ãƒˆã‚’æŠ‘ãˆãŸã‹ã£ãŸã®ãŒ1ç•ªã®ç†ç”±ã§ã™ã€‚
Cloudflare Workersã¯ç„¡æ–™ãƒ—ãƒ©ãƒ³ãŒã‚ã‚Šã€2025å¹´4æœˆç¾åœ¨ã§ã¯ã€Œ1æ—¥ã‚ãŸã‚Š10ä¸‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€1åˆ†ã‚ãŸã‚Š1,000ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ã¾ã§ç„¡æ–™ã§ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

https://developers.cloudflare.com/workers/platform/pricing/

### ğŸ™†â€â™‚ï¸ ã‚µãƒ¼ãƒãƒ¬ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã™ã‚‹ãƒ¡ãƒªãƒƒãƒˆ

**â—¼ï¸ ä½¿ç”¨ã—ãŸãƒªã‚½ãƒ¼ã‚¹ã®ã¿èª²é‡‘ã•ã‚Œã‚‹**
ç„¡æ–™æ ãŒæä¾›ã•ã‚Œã¦ã„ã‚‹ã‹ã¤ã€å¾“é‡èª²é‡‘åˆ¶ã«ãªã‚‹ãŸã‚ã€ä½¿ç”¨ã—ãŸåˆ†ã ã‘è²»ç”¨ãŒç™ºç”Ÿã—ã¾ã™ã€‚ãã®ãŸã‚ã€é‹ç”¨ã‚³ã‚¹ãƒˆã‚’äºˆæ¸¬ã—ã‚„ã™ãã€å°è¦æ¨¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ç„¡æ–™ã§é‹ç”¨ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚

**â—¼ï¸ è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°**
ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®é‡ã«å¿œã˜ã¦è‡ªå‹•çš„ã«ã‚¹ã‚±ãƒ¼ãƒ«ã—ã¦ãã‚Œã‚‹ãŸã‚ã€ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã«é–¢ã™ã‚‹é‹ç”¨è² è·ã‚’è»½æ¸›ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### ğŸ™…â€â™‚ï¸ ã‚µãƒ¼ãƒãƒ¬ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚’æ¡ç”¨ã™ã‚‹ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ

**â—¼ï¸ ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆ**
é•·æ™‚é–“ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã•ã‚Œã¦ã„ãªã„é–¢æ•°ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã¨ã€åˆæœŸåŒ–ã«æ™‚é–“ãŒã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

**â—¼ï¸ å®Ÿè¡Œæ™‚é–“ã«åˆ¶é™ãŒã‚ã‚‹**
å¤šãã®ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«ã¯ã€å®Ÿè¡Œæ™‚é–“ã®åˆ¶é™ãŒã‚ã‚Šã¾ã™ã€‚

## ãƒãƒ³ã‚ºã‚ªãƒ³
ã§ã¯ã€ã•ã£ãããƒãƒ³ã‚ºã‚ªãƒ³å½¢å¼ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿéš›ã«ä½œæˆã—ã¦ã„ãã¾ã™ã€‚

### 1. ç’°å¢ƒæº–å‚™

ã¾ãšã€å¿…è¦ãªãƒ„ãƒ¼ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦é–‹ç™ºç’°å¢ƒã‚’æ•´ãˆã¾ã™ã€‚
ï¼ˆæ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã®æ–¹ã¯ã€æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã«é€²ã‚“ã§ãã ã•ã„ï¼‰

#### å‰ææ¡ä»¶
- Node.js v20.5.1ä»¥ä¸ŠãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- pnpm v10.6.3ä»¥ä¸ŠãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã“ã¨

pnpmã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒã¾ã ã®æ–¹ã¯ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è¡Œãªã£ã¦ãã ã•ã„ã€‚
https://pnpm.io/ja/installation

### 2. ãƒ¢ãƒãƒ¬ãƒæ§‹æˆã®æ§‹ç¯‰

#### ğŸ‘¨â€ğŸ’» ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–
ã¾ãšã€pnpmã‚’ä½¿ç”¨ã—ã¦package.jsonã®åˆæœŸåŒ–ã‚’è¡Œã„ã¾ã™ã€‚
```bash
$ pnpm init
```

ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`package.json`ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
```json
{
  "name": "hono-nextjs-monorepo-zenn",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "dev": "turbo run dev",
    "build": "turbo run build",
    "test": "echo \"Error: no test specified\" && exit 1",
    "lint": "turbo run lint"
  },
  "devDependencies": {
    "prettier": "^3.5.1",
    "turbo": "2.4.4",
    "typescript": "^5.8.0"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "packageManager": "pnpm@10.7.0"
}
```
- `dev` : é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- `build` : ãƒ“ãƒ«ãƒ‰ã‚’è¡Œã†ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

#### ğŸ‘¨â€ğŸ’» pnpm Workspaceã®è¨­å®š
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’pnpm Workspaceã¨ã—ã¦è¨­å®šã™ã‚‹ãŸã‚ã«ã€ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`pnpm-workspace.yaml`ã‚’ä½œæˆã—ã¾ã™ã€‚
```yaml
packages:
  - 'packages/*'
```
ã“ã®è¨­å®šã«ã‚ˆã‚Šã€`packages`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ã™ã¹ã¦ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒpnpm Workspaceã¨ã—ã¦èªè­˜ã•ã‚Œã¾ã™ã€‚

#### ğŸ‘¨â€ğŸ’» Turborepoã®è¨­å®š
Turborepoã‚’è¨­å®šã™ã‚‹ãŸã‚ã«ã€ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`turbo.json`ã‚’ä½œæˆã—ã¾ã™ã€‚
```json
{
  "$schema": "https://turbo.build/schema.json",
  "globalDependencies": ["**/.env.*local"],
  "tasks": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": [".next/**", "!.next/cache/**", "dist/**"]
    },
    "lint": {},
    "format": {
      "outputs": []
    },
    "dev": {
      "cache": false,
      "persistent": true
    },
    "clean": {
      "cache": false
    }
  }
}
```
- `globalDependencies` : å…¨ã‚¿ã‚¹ã‚¯ã®ä¾å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡å®šã€‚ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã‚‹ã¨ã‚¿ã‚¹ã‚¯ãŒå†å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
- `tasks` : ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§å®Ÿè¡Œå¯èƒ½ãªã‚¿ã‚¹ã‚¯ã‚’å®šç¾©ã—ã¾ã™ã€‚
  - `build.dependsOn` : ãƒ“ãƒ«ãƒ‰å‰ã«å®Œäº†ã™ã¹ãä¾å­˜ã‚¿ã‚¹ã‚¯ã‚’æŒ‡å®šã€‚`^build`ã¯ã€Œãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä¾å­˜é–¢ä¿‚ã®ãƒ“ãƒ«ãƒ‰ã‚’å…ˆã«å®Ÿè¡Œã€ã‚’æ„å‘³ã—ã¾ã™ã€‚
  - `build.outputs` : ãƒ“ãƒ«ãƒ‰ã§ç”Ÿæˆã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ»ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥å¯¾è±¡ã¨ãªã‚Šã¾ã™ã€‚
  - `dev.cache: false` : é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã®çµæœã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã—ãªã„ã‚ˆã†ã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚
  - `dev.persistent: true` : é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ãŒå¸¸é§ãƒ—ãƒ­ã‚»ã‚¹ã¨ã—ã¦å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®è¨­å®šã«ã‚ˆã‚Šã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸é–“ã®ä¾å­˜é–¢ä¿‚ã‚’è€ƒæ…®ã—ãŸãƒ“ãƒ«ãƒ‰ã‚„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

#### ğŸ‘¨â€ğŸ’» å…±é€šã®TypeScriptè¨­å®š
ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«`tsconfig.json`ã‚’ä½œæˆã—ã¾ã™ã€‚
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ]
  },
  "exclude": ["node_modules"]
}
```
ã“ã¡ã‚‰ã®è©³ç´°ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ã¯ã€å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
https://www.typescriptlang.org/tsconfig/

### 3. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ§‹ç¯‰ï¼ˆHonoï¼‰
#### ğŸ‘¨â€ğŸ’» Honoã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
`packages`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«Honoã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åã¯`api`ã¨ã—ã¾ã™ã€‚
```bash
$ cd packages
```
```bash
$ pnpm create hono@latest
```
ğŸ‘‡Hono - Quick Start
https://hono.dev/docs/#quick-start
`pnpm create hono@latest`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€Honoã®åˆæœŸè¨­å®šã«é–¢ã™ã‚‹è³ªå•ãŒã„ãã¤ã‹è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚
![](/images/create-hono-success.png)
âœ… Target directory : `api`
âœ… Which template do you want to use? : `cloudflare-workers`
âœ… Do you want to install project dependencies? : `Yes`
âœ… Which package manager do you want to use? : `pnpm`

ã“ã‚Œã ã‘ã§ã€Honoã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå®Œäº†ã—ã¾ã™ã€‚
æ¬¡ã«ã€ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æˆ»ã‚Šã€`pnpm dev`ã‚’å®Ÿè¡Œã—ã¦ã€Honoã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£ã—ãå‹•ä½œã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
```bash
$ cd ..
$ pnpm dev
```
ğŸ‘‡ã‚¿ãƒ¼ãƒŸãƒŠãƒ«
![](/images/pnpm-dev-hono.png)
http://localhost:8787 ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ä»¥ä¸‹ã®ã‚ˆã†ãªç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸã§ã™ã€‚
![](/images/hello-hono.png)

### 4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®æ§‹ç¯‰ï¼ˆNext.jsï¼‰
#### ğŸ‘¨â€ğŸ’» Next.jsã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
æ¬¡ã«ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åã¯`frontend`ã¨ã—ã¾ã™ã€‚
```bash
$ cd packages
```
```bash
$ npx create-next-app@latest
```
ğŸ‘‡Next.js - Automatic installation
https://nextjs.org/docs/app/getting-started/installation#automatic-installation
`npx create-next-app@latest`ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€Next.jsã®åˆæœŸè¨­å®šã«é–¢ã™ã‚‹è³ªå•ãŒã„ãã¤ã‹è¡¨ç¤ºã•ã‚Œã‚‹ã®ã§ã€ä»¥ä¸‹ã®ã‚ˆã†ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚
![](/images/create-next-app.png)

âœ… What is your project named? : `frontend`
âœ… Would you like to use TypeScript? : `Yes`
âœ… Would you like to use ESLint? : `Yes`
âœ… Would you like to use Tailwind CSS? : `Yes`
âœ… Would you like your code inside a `src/` directory? : `Yes`
âœ… Would you like to use App Router? (recommended) : `Yes`
âœ… Would you like to use Turbopack for `next dev`? : `Yes`
âœ… Would you like to customize the import alias (`@/*` by default)? : `No`

ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æˆ»ã‚Šã€ä¸€åº¦é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’åœæ­¢ã—ã¦ã‹ã‚‰ã€å†åº¦`pnpm dev`ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
```bash
$ pnpm dev
```
http://localhost:3000 ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€Next.jsã®åˆæœŸç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚Œã°æˆåŠŸã§ã™ã€‚

ã“ã‚Œã§ã€ãƒ¢ãƒãƒ¬ãƒæ§‹æˆã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆHonoï¼‰ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆNext.jsï¼‰ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãã‚Œãã‚Œæ§‹ç¯‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã—ãŸã€‚

### 5. DBã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆSupabase / Drizzleï¼‰
#### ğŸ‘¨â€ğŸ’» Supabaseã®ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

æ¬¡ã«ã€Supabaseã®ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦ã„ãã¾ã™ã€‚
Supabaseã¯ã€PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€èªè¨¼ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãªã©ã®æ©Ÿèƒ½ã‚’æä¾›ã™ã‚‹BaaSãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚
https://supabase.com/

**â—¼ï¸ Supabase CLIã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
ã¾ãšã€Supabase CLIã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚Supabase CLIã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§Supabaseã‚’å®Ÿè¡Œã—ã€é–‹ç™ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
```bash
$ brew install supabase/tap/supabase
```

ğŸ‘‡ã“ã¡ã‚‰ã®å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã‚‚ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ–¹æ³•ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ã€‚
https://supabase.com/docs/guides/local-development/cli/getting-started?queryGroups=access-method&access-method=postgres

ğŸ‘‡Supabase CLIã¯ã€ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã«Dockerã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨ã—ã¾ã™ã®ã§ã€Dockerã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨è¨­å®šãŒå®Œäº†ã—ã¦ã„ãªã„æ–¹ã¯å…¬å¼ã‚¬ã‚¤ãƒ‰ã‚’å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚
https://docs.docker.com/desktop/

**â—¼ï¸ Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®åˆæœŸåŒ–**
æ¬¡ã«ã€Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚
```bash
$ cd packages/api
$ supabase init
```
ã“ã‚Œã«ã‚ˆã‚Šã€Supabaseã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚`supabase`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®`config.toml`ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€Supabaseã®è¨­å®šãŒè¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚
![](/images/supabase-init.png)

**â—¼ï¸ Supabaseãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®èµ·å‹•**
Supabaseã®ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‚’èµ·å‹•ã—ã¾ã™ã€‚
`packages/api`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
```bash
$ supabase start
```
ã“ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§SupabaseãŒèµ·å‹•ã—ã¾ã™ã€‚åˆå›å®Ÿè¡Œæ™‚ã¯Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãŒè¡Œã‚ã‚Œã‚‹ãŸã‚ã€å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚
ğŸ‘‡èµ·å‹•ãŒå®Œäº†ã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
```bash
Started supabase local development setup.

         API URL: http://localhost:54321
          DB URL: postgresql://postgres:postgres@localhost:54322/postgres
      Studio URL: http://localhost:54323
    Inbucket URL: http://localhost:54324
        anon key: eyJh......
service_role key: eyJh......
```
ã“ã‚Œã‚‰ã®æƒ…å ±ã¯å¾Œã§ä½¿ç”¨ã™ã‚‹ã®ã§ã€ãƒ¡ãƒ¢ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚

ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§èµ·å‹•ã—ã¦ã„ã‚‹Postgresã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã¯ã€DB URLã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã“ã¨ã§æ¥ç¶šã§ãã¾ã™ã€‚

**â—¼ï¸ ç’°å¢ƒå¤‰æ•°ã®è¨­å®š**
`packeges/api`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã€`.dev.vars`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
ä½œæˆã—ãŸ`.dev.vars`ãƒ•ã‚¡ã‚¤ãƒ«ã«ã€ä»¥ä¸‹ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
```env
DATABASE_URL=postgresql://postgres:postgres@localhost:54322/postgres
APP_FRONTEND_URL=http://localhost:3000
NODE_ENV=development
```

#### ğŸ‘¨â€ğŸ’» Drizzleã®DBã‚¹ã‚­ãƒ¼ãƒè¨­å®š
Drizzleã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚­ãƒ¼ãƒã‚’è¨­å®šã—ã¾ã™ã€‚
Drizzleã¯ã€TypeScriptã«ç‰¹åŒ–ã—ã¦è¨­è¨ˆã•ã‚ŒãŸORMã§ã€SQLã«è¿‘ã„æ§‹æ–‡ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
https://orm.drizzle.team/

**â—¼ï¸ Drizzleã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
`packages/api`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€Drizzleã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```bash
$ pnpm add drizzle-orm postgres
$ pnpm add -D drizzle-kit dotenv dotenv-cli
```
ğŸ‘‡SupabaseÃ—Drizzleã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ–¹æ³•ã«ã¤ã„ã¦
https://supabase.com/docs/guides/database/drizzle

`packages/api`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã€`drizzle.config.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
```ts
import { defineConfig } from "drizzle-kit";
import * as dotenv from "dotenv";

dotenv.config();

try {
  dotenv.config({ path: "./.dev.vars" });
} catch (error) {
  console.log("No .dev.vars file found");
}

const DATABASE_URL = process.env.DATABASE_URL;
if (!DATABASE_URL) {
  throw new Error("DATABASE_URL is not set");
}

export default defineConfig({
  dialect: "postgresql",
  schema: "./src/db/schema.ts",
  out: "./src/db/migrations",
  dbCredentials: {
    url: DATABASE_URL,
  },
});
```

:::message alert
`åå‰ 'process' ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒãƒ¼ãƒ‰ã®å‹å®šç¾©ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã‹? npm i --save-dev @types/node ã‚’è©¦ã—ã¦ã‹ã‚‰ã€tsconfig ã®å‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã« 'node' ã‚’è¿½åŠ ã—ã¦ã¿ã¦ãã ã•ã„`
â†‘ ã“ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆã¯ã€ãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€Node.jsã®å‹å®šç¾©ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚
```bash
$ pnpm add -D @types/node
```
:::

**â—¼ï¸ DBã‚¹ã‚­ãƒ¼ãƒã®ä½œæˆ**
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¹ã‚­ãƒ¼ãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
`packages/api/src/db`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ãã®ä¸­ã«`schema.ts`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
`packages/api/src/db/schema.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¯ã€ä»¥ä¸‹ã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã‚’è¡Œãªã£ã¦ãã ã•ã„ã€‚
```ts
import { pgTable, serial, text, varchar, timestamp } from "drizzle-orm/pg-core";

// è¨˜äº‹ãƒ†ãƒ¼ãƒ–ãƒ«
export const articles = pgTable("articles", {
  id: serial("id").primaryKey(),
  title: text("title").notNull(),
  content: text("content").notNull(),
  slug: varchar("slug", { length: 255 }).notNull().unique(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at").defaultNow().notNull(),
});

export const schema = { articles };

// å‹å®šç¾©ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨å…±æœ‰ã™ã‚‹ãŸã‚ï¼‰
export type Article = typeof articles.$inferSelect;
export type NewArticle = typeof articles.$inferInsert;
```

æ¬¡ã«ã€`packages/api/package.json`ã«ã€Drizzleå®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚
```json
"scripts": {
  "dev": "wrangler dev",
  "deploy": "wrangler deploy",
  "db:generate": "drizzle-kit generate",
  "db:migrate": "drizzle-kit migrate",
  "db:studio": "drizzle-kit studio",
  "db:push:local": "dotenv -e .dev.vars -- drizzle-kit push",
  "db:push:prod": "dotenv -e .prod.vars -- drizzle-kit push"
}
```

**â—¼ï¸ DBã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®è¨­å®š**
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šã‚’è¡Œã†ãŸã‚ã«ã€`packages/api/src/db/client.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šã¨ã¯ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨é€šä¿¡ã™ã‚‹ãŸã‚ã«å¿…è¦ãªæ¥ç¶šæƒ…å ±ã‚„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å®šç¾©ã™ã‚‹ã“ã¨ã§ã™ã€‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ©‹æ¸¡ã—çš„ãªå½¹å‰²ã‚’æœãŸã—ã¾ã™ã€‚
```ts
import { drizzle } from "drizzle-orm/postgres-js";
import postgres from "postgres";

export interface Env {
  DATABASE_URL: string;
  APP_FRONTEND_URL: string;
  NODE_ENV: string;
}

export function createClient(env: Env) {
  const connectionString = env.DATABASE_URL;

  const client = postgres(connectionString, {
    prepare: false,
    max: 1,
    idle_timeout: 20,
  });

  return drizzle(client);
}
```

ã¾ãŸã€Honoã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ãŸã‚ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã‚’ä½œæˆã—ã¦ãŠãã¾ã™ã€‚
`packages/api/src/helpers`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ãã®ä¸­ã«`dbClient.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
```ts
import { Context } from "hono";
import { createClient, Env } from "../db/client";

export const getDbClient = (c: Context<{ Bindings: Env }>) => {
  return createClient({
    DATABASE_URL: c.env.DATABASE_URL,
    APP_FRONTEND_URL: c.env.APP_FRONTEND_URL,
    NODE_ENV: c.env.NODE_ENV,
  });
};
```

**â—¼ï¸ ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ**
ã‚¹ã‚­ãƒ¼ãƒå®šç¾©ãŒå®Œäº†ã—ãŸã‚‰ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é©ç”¨ã—ã¦ã„ãã¾ã™ã€‚
`packages/api`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
```bash
$ pnpm run db:generate
$ pnpm run db:push:local
```
ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®Supabaseãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«`articles`ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¾ã—ãŸã€‚

http://localhost:54323 ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®Supabase Studioã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€`articles`ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
![](/images/supabase-articles.png)

ã“ã‚Œã§ã€Supabaseã®ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸã€‚

### 6. APIã®å®Ÿè£…ï¼ˆHonoï¼‰
æ¬¡ã«ã€articlesã®CRUDæ“ä½œã‚’è¡Œã†APIã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚
#### ğŸ‘¨â€ğŸ’» Zodã‚¹ã‚­ãƒ¼ãƒå®šç¾©
ã¾ãšã€APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ãŸã‚ã®Zodã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã¾ã™ã€‚
Zodã¯ã€ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã§ã®å‹ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã€TypeScriptã¨çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€å‹å®‰å…¨ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
https://zod.dev/

**â—¼ï¸ Zodã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
```bash
$ pnpm add zod
```
æ¬¡ã«ã€`@hono/zod-validator`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```bash
$ pnpm add @hono/zod-validator
```
`@hono/zod-validator`ã¯ã€Honoã¨Zodã‚’çµ„ã¿åˆã‚ã›ã¦ä½¿ç”¨ã™ã‚‹ãŸã‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã™ã€‚
ã“ã‚Œã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€Honoã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§Zodã‚’ä½¿ç”¨ã—ãŸãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç°¡å˜ã«è¡Œã†ã“ã¨ãŒã§ãã¾ã™ã€‚
**ğŸ‘‡@hono/zod-validator**
https://hono.dev/docs/guides/validation

**â—¼ï¸ Zodã‚¹ã‚­ãƒ¼ãƒã®ä½œæˆ**


`packages/api/src/schemas`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ãã®ä¸­ã«`article.ts`ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
```ts
import { z } from "zod";

export const articleSchema = z.object({
  id: z.number().optional(),
  title: z.string().min(1, "ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™").max(255, "ã‚¿ã‚¤ãƒˆãƒ«ã¯255æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„"),
  content: z.string().min(1, "å†…å®¹ã¯å¿…é ˆã§ã™"),
  slug: z
    .string()
    .min(1, "ã‚¹ãƒ©ãƒƒã‚°ã¯å¿…é ˆã§ã™")
    .max(255, "ã‚¹ãƒ©ãƒƒã‚°ã¯255æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„")
    .regex(/^[a-z0-9-]+$/, "ã‚¹ãƒ©ãƒƒã‚°ã¯å°æ–‡å­—è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿ä½¿ç”¨ã§ãã¾ã™"),
    createdAt: z.union([
      z.preprocess((val) => (typeof val === "string" ? new Date(val) : val), z.date()),
      z.string(),
    ]).optional(),
    updatedAt: z.union([
      z.preprocess((val) => (typeof val === "string" ? new Date(val) : val), z.date()),
      z.string(),
    ]).optional(),
});

export const createArticleSchema = articleSchema.omit({ id: true, createdAt: true, updatedAt: true });
export const updateArticleSchema = articleSchema.partial().omit({ id: true, createdAt: true, updatedAt: true });

export type Article = z.infer<typeof articleSchema>;
export type CreateArticle = z.infer<typeof createArticleSchema>;
export type UpdateArticle = z.infer<typeof updateArticleSchema>;
```
- `articleSchema` : è¨˜äº‹ã®ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã¾ã™ã€‚
- `createArticleSchema` : è¨˜äº‹ä½œæˆæ™‚ã®ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã¾ã™ã€‚
- `updateArticleSchema` : è¨˜äº‹æ›´æ–°æ™‚ã®ã‚¹ã‚­ãƒ¼ãƒã‚’å®šç¾©ã—ã¾ã™ã€‚
- `omit` : æŒ‡å®šã—ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’é™¤å¤–ã—ã¾ã™ã€‚
- `partial` : æŒ‡å®šã—ãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã«ã—ã¾ã™ã€‚
- `z.infer` : Zodã‚¹ã‚­ãƒ¼ãƒã‹ã‚‰TypeScriptã®å‹ã‚’ç”Ÿæˆã—ã¾ã™ã€‚ã“ã®è¨­å®šã«ã‚ˆã‚Šã€åˆ¥é€”å‹å®šç¾©ã‚’è¡Œã†å¿…è¦ãŒãªããªã‚Šã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§åŒã˜å‹ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

#### ğŸ‘¨â€ğŸ’» è¨˜äº‹ã®CRUD APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®Ÿè£…
`packages/api/src/routes`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ãã®ä¸­ã«`articles.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚

**â—¼ï¸ è¨˜äº‹ã®ä¸€è¦§å–å¾—**
```ts
import { Hono } from "hono";
import { Env } from "../db/client";
import { getDbClient } from "../helpers/dbClient";
import { articles } from "../db/schema";

export const articlesRoutes = new Hono<{ Bindings: Env }>()
  // è¨˜äº‹ä¸€è¦§å–å¾—
  .get("/articles", async (c) => {
    const db = getDbClient(c);
    const allArticles = await db.select().from(articles);

    return c.json({
      success: true,
      data: allArticles,
    });
  })
```

**â—¼ï¸ ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆè¨­å®š**
`packages/api/src/index.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚
```ts
import { Hono } from "hono";
import { cors } from "hono/cors";
import { Env } from "./db/client";
import { articlesRoutes } from "./routes/articles";

const app = new Hono<{ Bindings: Env }>()
  .use(
    "/*",
    cors({
      origin: (origin, c) => {
        return c.env.APP_FRONTEND_URL || "http://localhost:3000";
      },
      allowHeaders: ["Content-Type", "Authorization", "X-Requested-With"],
      allowMethods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
      exposeHeaders: ["Content-Length", "X-Kuma-Revision"],
      maxAge: 864_000,
      credentials: true,
    })
  )
  // APIãƒ«ãƒ¼ãƒˆç™»éŒ²
  .route("/api/", articlesRoutes);

export default app;
export type AppType = typeof app;
```
- `cors` : CORSãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’ä½¿ç”¨ã—ã¦ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¨±å¯ã—ã¾ã™ã€‚
- `origin` : è¨±å¯ã™ã‚‹ã‚ªãƒªã‚¸ãƒ³ã‚’æŒ‡å®šã—ã¾ã™ã€‚ç’°å¢ƒå¤‰æ•°`APP_FRONTEND_URL`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã—ã€ãã†ã§ãªã„å ´åˆã¯`http://localhost:3000`ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
- `.route("/api/", articlesRoutes)` : `/api/`ä»¥ä¸‹ã®ãƒ«ãƒ¼ãƒˆã«å¯¾ã—ã¦ã€`articlesRoutes`ã‚’ç™»éŒ²ã—ã¾ã™ã€‚`articlesRoutes`ã¯ã€`packages/api/src/routes/articles.ts`ã§å®šç¾©ã—ãŸãƒ«ãƒ¼ãƒˆã§ã™ã€‚ã“ã®è¨­å®šã«ã‚ˆã‚Šã€`/api/articles`ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€`articlesRoutes`ãŒå‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚
- `export type AppType = typeof app` : Honoã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‹ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§Honoã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å‹ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
- `export default app` : Honoã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€Cloudflare Workersã§Honoã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

:::message alert
`[ERROR] service core:user:api: Uncaught Error: No such module "node:events".]`ã¨ã„ã†ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€Cloudflare Workersã§Node.jsäº’æ›ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚`packages/api/wrangler.jsonc`ãƒ•ã‚¡ã‚¤ãƒ«ã«ã€`"compatibility_flags": ["nodejs_compat"] `ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚
:::

**â—¼ï¸ è¨˜äº‹ä¸€è¦§å–å¾—ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å©ã„ã¦ã¿ã‚‹**
`pnpm dev`ã‚’å®Ÿè¡Œã—ã¦ã€Honoã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•ã—ã¦ã€ http://localhost:8787/api/articles ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã¦ã¿ã¦ãã ã•ã„ã€‚
```bash
$ curl -X GET http://localhost:8787/api/articles
```
ã¾ã ã€è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ã‚’ç™»éŒ²ã—ã¦ã„ãªã„ã®ã§ã€`{"success":true,"data":[]}`ã¨ã„ã†ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã£ã¦ããŸã‚‰æˆåŠŸã§ã™ã€‚
![](/images/articles-get.png)

**â—¼ï¸ è¨˜äº‹ã®è©³ç´°ãƒ»ä½œæˆãƒ»æ›´æ–°ãƒ»å‰Šé™¤**
æ¬¡ã«ã€è¨˜äº‹ã®è©³ç´°å–å¾—ã€ä½œæˆã€æ›´æ–°ã€å‰Šé™¤ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚‚å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚
```ts
import { Hono } from "hono";
import { Env } from "../db/client";
import { getDbClient } from "../helpers/dbClient";
import { articles } from "../db/schema";
import { eq } from "drizzle-orm";
import { zValidator } from "@hono/zod-validator";
import { createArticleSchema, updateArticleSchema } from "../schemas/article";

export const articlesRoutes = new Hono<{ Bindings: Env }>()
  // è¨˜äº‹ä¸€è¦§å–å¾—
  .get("/articles", async (c) => {
    const db = getDbClient(c);
    const allArticles = await db.select().from(articles);

    return c.json({
      success: true,
      data: allArticles,
    });
  })

  // è¨˜äº‹è©³ç´°å–å¾—
  .get("/articles/:slug", async (c) => {
    const db = getDbClient(c);
    const slug = c.req.param("slug");
    const article = await db
      .select()
      .from(articles)
      .where(eq(articles.slug, slug))
      .limit(1);

    if (!article.length) {
      return c.json(
        {
          success: false,
          message: "è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“",
        },
        404
      );
    }

    return c.json({
      success: true,
      data: article[0],
    });
  })

  // è¨˜äº‹ä½œæˆ
  .post("/articles", zValidator("json", createArticleSchema), async (c) => {
    const articleData = c.req.valid("json");
    const db = getDbClient(c);

    // ã‚¹ãƒ©ãƒƒã‚°ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    const existingArticle = await db
      .select({ id: articles.id })
      .from(articles)
      .where(eq(articles.slug, articleData.slug))
      .limit(1);

    if (existingArticle.length) {
      return c.json(
        {
          success: false,
          message: "ã“ã®ã‚¹ãƒ©ãƒƒã‚°ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™",
        },
        400
      );
    }

    const newArticle = await db.insert(articles).values(articleData).returning();

    return c.json({
      success: true,
      data: newArticle[0],
    });
  })

  // è¨˜äº‹æ›´æ–°
  .put("/articles/:slug", zValidator("json", updateArticleSchema), async (c) => {
    const articleData = c.req.valid("json");
    const slug = c.req.param("slug");
    const db = getDbClient(c);

    // æ›´æ–°å¯¾è±¡ã®è¨˜äº‹ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    const existingArticle = await db
      .select({ id: articles.id })
      .from(articles)
      .where(eq(articles.slug, slug))
      .limit(1);

    if (!existingArticle.length) {
      return c.json(
        {
          success: false,
          message: "è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“",
        },
        404
      );
    }

    // ã‚¹ãƒ©ãƒƒã‚°ãŒå¤‰æ›´ã•ã‚Œã‚‹å ´åˆã€æ–°ã—ã„ã‚¹ãƒ©ãƒƒã‚°ãŒæ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ãªã„ã‹ç¢ºèª
    if (articleData.slug && articleData.slug !== slug) {
      const duplicateSlug = await db
        .select({ id: articles.id })
        .from(articles)
        .where(eq(articles.slug, articleData.slug))
        .limit(1);

      if (duplicateSlug.length) {
        return c.json(
          {
            success: false,
            message: "ã“ã®ã‚¹ãƒ©ãƒƒã‚°ã¯æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™",
          },
          400
        );
      }
    }

    const updatedArticle = await db
      .update(articles)
      .set({ ...articleData, updatedAt: new Date() })
      .where(eq(articles.slug, slug))
      .returning();

    return c.json({
      success: true,
      data: updatedArticle[0],
    });
  })

  // è¨˜äº‹å‰Šé™¤
  .delete("/articles/:slug", async (c) => {
    const slug = c.req.param("slug");
    const db = getDbClient(c);

    const deletedArticle = await db
      .delete(articles)
      .where(eq(articles.slug, slug))
      .returning();

    if (!deletedArticle.length) {
      return c.json(
        {
          success: false,
          message: "è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“",
        },
        404
      );
    }

    return c.json({
      success: true,
      data: deletedArticle[0],
    });
  });
```

**â—¼ï¸ APIã®å‹•ä½œç¢ºèª**
ã§ã¯ã€å®Ÿéš›ã«APIã‚’å©ã„ã¦ã¿ã¦å‹•ä½œç¢ºèªã‚’è¡Œã„ã¾ã™ã€‚
- è¨˜äº‹ä½œæˆ : `POST /api/articles`
```bash
$ curl -X POST http://localhost:8787/api/articles \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Test Article",
    "content": "This is a test article.",
    "slug": "test-article"
  }'
```
- è¨˜äº‹ä¸€è¦§å–å¾— : `GET /api/articles`
```bash
$ curl -X GET http://localhost:8787/api/articles
```
- è¨˜äº‹è©³ç´°å–å¾— : `GET /api/articles/test-article`
```bash
$ curl -X GET http://localhost:8787/api/articles/test-article
```
- è¨˜äº‹æ›´æ–° : `PUT /api/articles/test-article`
```bash
$ curl -X PUT http://localhost:8787/api/articles/test-article \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Updated Test Article",
    "content": "This is an updated test article.",
    "slug": "updated-test-article"
  }'
```
- è¨˜äº‹å‰Šé™¤ : `DELETE /api/articles/test-article`
```bash
$ curl -X DELETE http://localhost:8787/api/articles/updated-test-article
```

ã“ã‚Œã§ã€è¨˜äº‹ã®CRUDæ“ä½œãŒã§ãã‚‹APIãŒå®Œæˆã§ã™ã€‚

### 7. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…ï¼ˆNext.jsï¼‰
æ¬¡ã«ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰APIã‚’å©ã„ã¦ã€è¨˜äº‹ã®ä¸€è¦§è¡¨ç¤ºã€è©³ç´°è¡¨ç¤ºã€ä½œæˆã€æ›´æ–°ã€å‰Šé™¤ã‚’è¡Œã†æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

#### ğŸ‘¨â€ğŸ’» APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ä½œæˆ
ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã¨é€šä¿¡ã™ã‚‹ãŸã‚ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’è¨­å®šã—ã¾ã™ã€‚
`packages/frontend/src/lib`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ãã®ä¸­ã«`client.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚
`client.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’å®šç¾©ã™ã‚‹ãŸã‚ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™ã€‚APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã¨é€šä¿¡ã™ã‚‹ãŸã‚ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚
```ts
import { AppType } from "@api/index";
import { hc } from "hono/client";

const API_BASE_URL = process.env.NEXT_PUBLIC_API_URL || "http://localhost:8787";

export const apiClient = hc<AppType>(API_BASE_URL);
```

**â—¼ï¸ hono/clientã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
`hono/client`ã¯ã€Honoãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚ã“ã‚Œã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€Honoã§å®šç¾©ã—ãŸAPIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦ç°¡å˜ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
`packages/frontend`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ã€`hono/client`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚
```bash
pnpm add hono
```

**â—¼ï¸ TypeScriptã®ãƒ‘ã‚¹ã‚¨ã‚¤ãƒªã‚¢ã‚¹è¨­å®š**
APIãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‹ã‚‰ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‘ã‚¹ã‚’ç°¡æ½”ã«ã™ã‚‹ãŸã‚ã«ã€`packages/frontend/tsconfig.json`ã«ãƒ‘ã‚¹ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’è¨­å®šã—ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€APIãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å‹å®šç¾©ã‚’ç°¡å˜ã«å‚ç…§ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```json
{
  "compilerOptions": {
    "paths": {
      "@/*": ["./src/*"],
      "@api/*": ["../api/src/*"]
    }
  }
}
```


#### ğŸ‘¨â€ğŸ’» ç’°å¢ƒå¤‰æ•°ã®è¨­å®š
`packages/frontend/.env.local`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
```env
NEXT_PUBLIC_API_URL=http://localhost:8787
```

#### ğŸ‘¨â€ğŸ’» è¨˜äº‹ä¸€è¦§ãƒšãƒ¼ã‚¸ã®å®Ÿè£…
è¨˜äº‹ä¸€è¦§ç”»é¢ã‚’ä½œæˆã—ã€è¨˜äº‹ã®ä¸€è¦§ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
`packages/frontend/src/app/articles/page.tsx`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
```tsx


import { getArticles } from "@/services/articles";
import Link from "next/link";

export default async function Home() {
  const { data: articles } = await getArticles();

  return (
    <main className="container mx-auto p-4">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold">è¨˜äº‹ä¸€è¦§</h1>
        <Link
          href="/articles/new"
          className="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded"
        >
          æ–°è¦ä½œæˆ
        </Link>
      </div>

      {articles.length === 0 ? (
        <p className="text-gray-500">è¨˜äº‹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ã„è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>
      ) : (
        <div className="grid gap-4">
          {articles.map((article) => (
            <div key={article.id} className="border p-4 rounded shadow">
              <h2 className="text-xl font-semibold">{article.title}</h2>
              <p className="text-gray-600 mt-2 line-clamp-2">{article.content}</p>
              <div className="mt-4 flex gap-2">
                <Link
                  href={`/articles/${article.slug}`}
                  className="text-blue-500 hover:underline"
                >
                  è©³ç´°ã‚’è¦‹ã‚‹
                </Link>
                <Link
                  href={`/articles/${article.slug}/edit`}
                  className="text-green-500 hover:underline"
                >
                  ç·¨é›†
                </Link>
              </div>
            </div>
          ))}
        </div>
      )}
    </main>
  );
}
```

**â—¼ï¸ è¨˜äº‹ä¸€è¦§å–å¾—APIã®å®Ÿè£…**
è¨˜äº‹ä¸€è¦§ã‚’å–å¾—ã™ã‚‹ãŸã‚ã®APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
`packages/frontend/src/app/services/articles`ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆã—ã€ãã®ä¸­ã«`index.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
```ts
import { apiClient } from "@/lib/client";
import { Article } from "@api/schemas/article";

export async function getArticles(): Promise<{ success: boolean; data: Article[] }> {
  const response = await apiClient.api.articles.$get();
  return response.json();
}
```

curlã‚³ãƒãƒ³ãƒ‰ã§è¨˜äº‹ã‚’ä½œæˆã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```bash
$ curl -X POST http://localhost:8787/api/articles \
  -H "Content-Type: application/json" \
  -d '{
    "title": "Test Article",
    "content": "This is a test article.",
    "slug": "test-article"
  }'
```

http://localhost:3000/articles ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€ä»¥ä¸‹ã®ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
![](/images/articles-page.png)

#### ğŸ‘¨â€ğŸ’» è¨˜äº‹è©³ç´°è¡¨ç¤ºãƒšãƒ¼ã‚¸ã®å®Ÿè£…
è¨˜äº‹ã®è©³ç´°ã‚’è¡¨ç¤ºã™ã‚‹ãƒšãƒ¼ã‚¸ã‚’å®Ÿè£…ã—ã¾ã™ã€‚
`packages/frontend/src/app/articles/[slug]/page.tsx`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®å†…å®¹ã‚’è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚
```tsx
import DeleteButton from "@/app/articles/_components/DeleteButton";
import { getArticle } from "@/services/articles";
import Link from "next/link";

export default async function ArticleDetail({ params }: { params: { slug: string } }) {
  const { success, data: article } = await getArticle(params.slug);

  if (!success || !article) {
    return (
      <div className="container mx-auto p-4">
        <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
          è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚
        </div>
        <div className="mt-4">
          <Link href="/" className="text-blue-500 hover:underline">
            è¨˜äº‹ä¸€è¦§ã«æˆ»ã‚‹
          </Link>
        </div>
      </div>
    );
  }

  return (
    <div className="container mx-auto p-4">
      <article className="prose lg:prose-xl max-w-none">
        <h1>{article.title}</h1>
        <div className="text-gray-500 text-sm mb-6">
          ä½œæˆæ—¥: {article.createdAt ? new Date(article.createdAt).toLocaleDateString() : "ä¸æ˜"}
          {article.updatedAt !== article.createdAt &&
            ` â€¢ æ›´æ–°æ—¥: ${article.updatedAt ? new Date(article.updatedAt).toLocaleDateString() : "ä¸æ˜"}`}
        </div>

        <div className="whitespace-pre-wrap">{article.content}</div>
      </article>

      <div className="mt-8 flex gap-2">
        <Link
          href="/"
          className="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded"
        >
          ä¸€è¦§ã«æˆ»ã‚‹
        </Link>
        <Link
          href={`/articles/${article.slug}/edit`}
          className="bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded"
        >
          ç·¨é›†
        </Link>
        <DeleteButton slug={article.slug} />
      </div>
    </div>
  );
}
```
`packages/frontend/src/app/articles/_components/DeleteButton.tsx`
```tsx
"use client";

import { deleteArticle } from "@/services/articles";
import { useRouter } from "next/navigation";
import { useState } from "react";

export default function DeleteButton({ slug }: { slug: string }) {
  const router = useRouter();
  const [isDeleting, setIsDeleting] = useState(false);

  const handleDelete = async () => {
    if (!confirm("æœ¬å½“ã«ã“ã®è¨˜äº‹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
      return;
    }

    setIsDeleting(true);
    try {
      const result = await deleteArticle(slug);
      if (result.success) {
        router.push("/articles");
        router.refresh();
      } else {
        alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: " + result.message);
      }
    } catch (err) {
      console.error(err);
      alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
    } finally {
      setIsDeleting(false);
    }
  };

  return (
    <button
      onClick={handleDelete}
      disabled={isDeleting}
      className="bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded disabled:opacity-50"
    >
      {isDeleting ? "å‰Šé™¤ä¸­..." : "å‰Šé™¤"}
    </button>
  );
}
```

**â—¼ï¸ è¨˜äº‹è©³ç´°å–å¾—ã¨å‰Šé™¤APIã®å®Ÿè£…**
``packages/frontend/src/app/services/articles/index.ts``ãƒ•ã‚¡ã‚¤ãƒ«ã«ã€è¨˜äº‹è©³ç´°å–å¾—ã¨å‰Šé™¤APIã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’è¿½åŠ ã—ã¾ã™ã€‚
```ts
export async function getArticle(slug: string): Promise<{ success: boolean; data?: Article }> {
  const response = await apiClient.api.articles[":slug"].$get({
    param: { slug },
  });
  return await response.json();
}

export async function deleteArticle(slug: string): Promise<{ success: boolean; data?: Article }> {
  const response = await apiClient.api.articles[":slug"].$delete({
    param: { slug },
  });
  return await response.json();
}
```

http://localhost:3000/articles/test-article ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã€è¨˜äº‹ã®è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
ã¾ãŸã€è¨˜äº‹ã®å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€è¨˜äº‹ãŒå‰Šé™¤ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
[![Image from Gyazo](https://i.gyazo.com/817e43a7b96231c8ef297f3c1a55e062.gif)](https://gyazo.com/817e43a7b96231c8ef297f3c1a55e062)


## å‚è€ƒæ–‡çŒ®
https://zenn.dev/yasse/articles/2650d580ae8392
